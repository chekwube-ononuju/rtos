#include <WiFi.h>
#include <WebServer.h>

// =======================
// Wi-Fi credentials
// =======================
// TODO: put your hotspot / router name + password here
const char* ssid     = "Park East";
const char* password = "CatchLionWhippet";

// HTTP server on port 80
WebServer server(80);

// On ESP32-CAM (AI Thinker) the white flash LED is usually GPIO 4
const int LED_PIN = 4;
bool ledState = false;

// =======================
// HTML Dashboard Page
//  - Served by ESP32
//  - JavaScript inside talks directly to Supabase
// =======================
const char index_html[] PROGMEM = R"rawliteral(
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ESP32 + Supabase Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111827;
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }
    .card {
      background: #1f2933;
      max-width: 480px;
      margin: 0 auto;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    h2 {
      margin-top: 0;
      color: #f9fafb;
      text-align: center;
    }
    .row {
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
    }
    .label {
      font-weight: 600;
      color: #9ca3af;
    }
    .value {
      font-family: "SF Mono", Menlo, monospace;
    }
    button {
      border: none;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>ESP32 + Supabase Dashboard</h2>

    <!-- Supabase data (latest row from sensor_data) -->
    <div class="row">
      <span class="label">ID</span>
      <span class="value" id="id_db">--</span>
    </div>
    <div class="row">
      <span class="label">Timestamp</span>
      <span class="value" id="created_at_db">--</span>
    </div>
    <div class="row">
      <span class="label">Bus Voltage 1</span>
      <span class="value" id="bus_voltage_1_db">--</span>
    </div>
    <div class="row">
      <span class="label">Shunt Voltage 1</span>
      <span class="value" id="shunt_voltage_1_db">--</span>
    </div>
    <div class="row">
      <span class="label">Current 1</span>
      <span class="value" id="current_1_db">--</span>
    </div>
    <div class="row">
      <span class="label">Power 1</span>
      <span class="value" id="power_1_db">--</span>
    </div>

    <!-- ESP32 LED control -->
    <div class="row" style="margin-top:16px;">
      <span class="label">LED</span>
      <span class="value" id="ledState">OFF</span>
    </div>
    <button id="ledBtn" onclick="toggleLed()">Turn ON</button>
  </div>

  <script>
    // ========= SUPABASE CONFIG =========
    const SUPABASE_URL = 'https://wzxesvppkbwecmtgvmkc.supabase.co';
    const SUPABASE_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6eGVzdnBwa2J3ZWNtdGd2bWtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4MDQ4NTksImV4cCI6MjA3ODM4MDg1OX0.9gF5Bq0PXc1g3NJqk5Go_7061HPKwWKAFAhSNBjBir0';

    // Fetch latest row from sensor_data
    async function loadFromSupabase() {
      try {
        const url =
          SUPABASE_URL +
          '/rest/v1/sensor_data' +
          '?select=id,created_at,bus_voltage_1,shunt_voltage_1,current_1,power_1' +
          '&order=created_at.desc' +
          '&limit=1';

        const response = await fetch(url, {
          headers: {
            apikey: SUPABASE_KEY,
            Authorization: 'Bearer ' + SUPABASE_KEY,
          },
        });

        if (!response.ok) {
          console.error('Supabase error:', await response.text());
          return;
        }

        const rows = await response.json();
        if (rows.length > 0) {
          const row = rows[0];

          document.getElementById('id_db').textContent =
            row.id ?? '--';
          document.getElementById('created_at_db').textContent =
            row.created_at ?? '--';
          document.getElementById('bus_voltage_1_db').textContent =
            row.bus_voltage_1 ?? '--';
          document.getElementById('shunt_voltage_1_db').textContent =
            row.shunt_voltage_1 ?? '--';
          document.getElementById('current_1_db').textContent =
            row.current_1 ?? '--';
          document.getElementById('power_1_db').textContent =
            row.power_1 ?? '--';
        }
      } catch (err) {
        console.error('Error talking to Supabase:', err);
      }
    }

    // ========= ESP32 LED CONTROL =========
    function toggleLed() {
      fetch('/toggle', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          const ledSpan = document.getElementById('ledState');
          const btn = document.getElementById('ledBtn');
          if (data.led) {
            ledSpan.textContent = 'ON';
            btn.textContent = 'Turn OFF';
          } else {
            ledSpan.textContent = 'OFF';
            btn.textContent = 'Turn ON';
          }
        })
        .catch(error => console.error('Error toggling LED:', error));
    }

    // Poll Supabase every 2 seconds
    setInterval(loadFromSupabase, 2000);
    window.onload = () => {
      loadFromSupabase();
    };
  </script>
</body>
</html>
)rawliteral";

// =======================
// HTTP Handlers
// =======================

// Serve the dashboard HTML
void handleRoot() {
  server.send_P(200, "text/html", index_html);
}

// Toggle LED and return new state as JSON
void handleToggle() {
  ledState = !ledState;
  digitalWrite(LED_PIN, ledState ? HIGH : LOW);

  String json = "{";
  json += "\"led\":";
  json += (ledState ? "true" : "false");
  json += "}";

  server.send(200, "application/json", json);
}

// 404 handler
void handleNotFound() {
  server.send(404, "text/plain", "Not found");
}

// =======================
// Setup & Loop
// =======================
void setup() {
  Serial.begin(115200);
  delay(1000);

  pinMode(LED_PIN, OUTPUT);
  digitalWrite(LED_PIN, LOW);
  ledState = false;

  Serial.println();
  Serial.println("Starting ESP32 + Supabase Web Dashboard...");

  // Connect to Wi-Fi (station mode)
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println();
  Serial.println("WiFi connected!");
  Serial.print("IP address: ");
  Serial.println(WiFi.localIP());

  // Route handlers
  server.on("/", handleRoot);
  server.on("/toggle", HTTP_POST, handleToggle);
  server.onNotFound(handleNotFound);

  // Start server
  server.begin();
  Serial.println("HTTP server started");
}

void loop() {
  server.handleClient();
}
